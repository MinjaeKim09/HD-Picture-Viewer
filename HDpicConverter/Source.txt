using System;
using System.IO;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;
using System.Windows.Forms;
using System.Drawing.Imaging;
using System.Drawing.Drawing2D;

namespace HD_Picture_Converter_CE
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private Image Img;
        private Size OriginalImageSize;
        private Size ModifiedImageSize;
        private Settings SettingsForum;
        
        int cropWidth;
        int cropHeight;
        int errorCode = 0;
        int highQualityCrop=1;
        int conversionFail = 0;
        double AspectRatio;

        //double ratioX;
        //double ratioY;
        
        string AppDir;
        string path;
        string[] iniLines;
        string Filename;
        string FilenameFive;
        string FilenameEight;
        public Pen cropPen;

        public DashStyle cropDashStyle = DashStyle.DashDot;
        public bool Makeselection = false;
        public bool SettingsExpandCheck;

        private void Form1_Load(object sender, EventArgs e)
        {
            LogBox.Text = "Open an image to convert!";
        }

        private void OpenButton_Click(object sender, EventArgs e)
        {

            progressBar1.Value = 0;

            OpenFileDialog Dlg = new OpenFileDialog();

            Dlg.Filter = "";

            Dlg.Title = "Select image";

            if (Dlg.ShowDialog() == System.Windows.Forms.DialogResult.OK)
            {
                Img = Image.FromFile(Dlg.FileName);
                Filename=Dlg.FileName;
                Filename = Path.GetFileName(Filename);
                
                LoadImage();
            }
            else
            {
                return;
            }
            LogBox.Text = "Resizing image...";
            progressBar1.Increment(25);
            if (OriginalImageSize.Width > 320 || OriginalImageSize.Height > 240)
            {
                MessageBox.Show("Error: Image too big!");
                LogBox.Text = "Your image is either too tall or too wide. \nMake sure your image is at most 320 pixels wide and 240 pixels tall.\n Try resizing the image using a software such as Paint. \nAuto-resizing may come in a future update!";
                return;
            }else
            {
                ResizeImage();
                
            }
            
            LogBox.Text = "Cropping image...";
            progressBar1.Increment(25);
            highQualityCrop = 1;
            Crop();
            LogBox.Text = "Saving and running convPNG.exe";
            progressBar1.Increment(25);
            //saves images, creates new ini
            SaveCreate();
            progressBar1.Increment(25);
            if (conversionFail == 0)
            {
                LogBox.Text = "Finished! The image has been saved into 3 app vars: " + Filename + "R.8xv, " + Filename + "L.8xv, and "+Filename+"P.8xv. \nSend all 3 to your calculator and view the image with the HDpic program! \nYou can now open another image to convert!";
                AdditionalLog.Text = "Image width: " + ModifiedImageSize.Width + " Image height: " + ModifiedImageSize.Height;

            }
            else
            {
                LogBox.Text = "Error, image could not be converted! \nIf you can't fix it yourself, please contact TheLastMillennial on Cemetech \nHere: www.ceme.tech/t14498";
                AdditionalLog.Text = "Error code: " + errorCode;
                conversionFail = 0;
            }
        }


        private void LoadImage()
        {
            errorCode = 10;
            //we set the picturebox size according to image, we can get image width and height with the help of Image.Width and Image.height properties.
            int imgWidth = Img.Width;
            int imgHeight = Img.Height;
            LeftPictureBox.Width = imgWidth;
            LeftPictureBox.Height = imgHeight;
            LeftPictureBox.Image = Img;

            /*RightPictureBox.Image = Img;
            RightPictureBox.Width = imgWidth;
            RightPictureBox.Height = imgHeight;*/

            //PictureBoxLocation();
            OriginalImageSize = new Size(imgWidth, imgHeight);

            //SetResizeInfo();
            errorCode = 19;
        }
        private void btnOk_Click(object sender, EventArgs e)
        {
            errorCode = 20;
            Bitmap bm_source = new Bitmap(LeftPictureBox.Image);
            // Make a bitmap for the result.
            Bitmap bm_dest = new Bitmap(Convert.ToInt32(ModifiedImageSize.Width), Convert.ToInt32(ModifiedImageSize.Height));
            // Make a Graphics object for the result Bitmap.
            Graphics gr_dest = Graphics.FromImage(bm_dest);
            // Copy the source image into the destination bitmap.
            gr_dest.DrawImage(bm_source, 0, 0, bm_dest.Width + 1, bm_dest.Height + 1);
            // Display the result.
            LeftPictureBox.Image = bm_dest;
            LeftPictureBox.Width = bm_dest.Width;
            LeftPictureBox.Height = bm_dest.Height;

            

            //PictureBoxLocation();
            errorCode = 29;
        }

        private void ResizeImage()
        {

            try
            {
                


                ModifiedImageSize.Width = OriginalImageSize.Width;
                ModifiedImageSize.Height = OriginalImageSize.Height;

                /*
                //AspectRatio = (double)OriginalImageSize.Width / (double)OriginalImageSize.Height;
                //Console.WriteLine("AR: " + AspectRatio);
                Bitmap OriginalImage = new Bitmap(LeftPictureBox.Image, LeftPictureBox.Width, LeftPictureBox.Height);
                double ratioX = (double)320 / OriginalImageSize.Width;
                double ratioY = (double)240 / OriginalImageSize.Height;
                double ratio = Math.Min(ratioX, ratioY);
                Console.WriteLine("Ratio: "+ratio);
                ModifiedImageSize.Width = (int)(Img.Width * ratio);
                ModifiedImageSize.Height = (int)(Img.Height * ratio);

                Bitmap resizedImg = new Bitmap(ModifiedImageSize.Width, ModifiedImageSize.Height);

                //using (var graphics = Graphics.FromImage(resizedImg))
                    //graphics.DrawImage(OriginalImage, 0, 0, ModifiedImageSize.Width, ModifiedImageSize.Height);

                
                LeftPictureBox.Width = ModifiedImageSize.Width;
                LeftPictureBox.Height = ModifiedImageSize.Height;
                LeftPictureBox.Image = resizedImg;
                
                LeftPictureBox.Refresh();
                MessageBox.Show("1");
                
                Console.WriteLine("H: " + ModifiedImageSize.Height.ToString());
            Console.WriteLine("W: " + ModifiedImageSize.Width.ToString());
                errorCode = 36;
                */

            }
            catch (Exception)
            {
                
                MessageBox.Show("Error! Code: "+errorCode);
                return;
            }
           
    }
        private void Crop()
        {
            errorCode = 40;
            cropWidth = ModifiedImageSize.Width / 2;
            cropHeight = ModifiedImageSize.Height;
            Rectangle Lrect = new Rectangle(0, 0, cropWidth, ModifiedImageSize.Height);
            Rectangle Rrect = new Rectangle(cropWidth, 0, cropWidth, ModifiedImageSize.Height);
            Console.WriteLine("MFW: "+(ModifiedImageSize.Width / 2).ToString());

            Bitmap OriginalImage = new Bitmap(LeftPictureBox.Image, LeftPictureBox.Width, LeftPictureBox.Height);
            //Original image

            Bitmap _Limg = new Bitmap(cropWidth, cropHeight);
            Bitmap _Rimg = new Bitmap(cropWidth, cropHeight);

            //crops?
            //_Limg = new Bitmap(Lrect.Width, Lrect.Height);
            //_Rimg = new Bitmap(Rrect.Width, Rrect.Height);

            using (Graphics g = Graphics.FromImage(_Limg))
            {
                g.DrawImage(OriginalImage, new Rectangle(0, 0, _Limg.Width, _Limg.Height),Lrect,GraphicsUnit.Pixel);
            }

            using (Graphics g = Graphics.FromImage(_Rimg))
            {
                g.DrawImage(OriginalImage, new Rectangle(0, 0, _Rimg.Width, _Rimg.Height), Rrect, GraphicsUnit.Pixel);
            }
            LeftPictureBox.Image = _Limg;
            RightPictureBox.Image = _Rimg;


            //I dunno what this did anymore
            /*LeftPictureBox.Image = _Limg;
            LeftPictureBox.Width = _Limg.Width;
            LeftPictureBox.Height = _Limg.Height;

                System.Drawing.Imaging.PixelFormat format = _Rimg.PixelFormat;
            Bitmap _Rimg2 = OriginalImage.Clone(Rrect, format);
            
            // Draw the cloned portion of the Bitmap object.
            //Rg.DrawImage(_Rimg2, 0, 0);

            RightPictureBox.Image = _Rimg2;
            RightPictureBox.Width = _Rimg.Width;
            RightPictureBox.Height = _Rimg.Height;
            */
            BoxLocations();
            LeftPictureBox.Refresh();
            RightPictureBox.Refresh();
            errorCode = 49;
        }

        private void BoxLocations()
        {
            LeftPictureBox.Location=new Point(50,120);
            RightPictureBox.Location = new Point(250, 120);
        }

        private void SaveCreate()
        {
            errorCode = 50;
            //gets directory of this program
            AppDir = AppDomain.CurrentDomain.BaseDirectory;
            //debugging, doesn't effect the program
            Console.WriteLine("Dir: "+AppDir);
            errorCode = 52;
            //saves the pictures as pngs
            LeftPictureBox.Image.Save(AppDir + @"Left.png", ImageFormat.Png);
            long length= new System.IO.FileInfo(AppDir + @"Left.png").Length;

            RightPictureBox.Image.Save(AppDir + @"Right.png", ImageFormat.Png);
            //makes sure file name is correct length 
            FilenameEight = Filename;
            FilenameFive = Filename;
            //I have this as 7 for the app var name allowing a L or R to be placed at the end
            if (Filename.Length > 7)
                Filename = Filename.Substring(0, 7);
            
            //I have this as 8 for the header
            if (FilenameEight.Length > 8)
            {
                FilenameEight = FilenameEight.Substring(0, 8);
            }
            else
            {
                //This loops until the header is 8 chars long
                while (Filename.Length < 8)
                {
                    Filename = Filename + " ";
                }
            }
            errorCode = 54;
            //Detects if the images were previously created, if so, it deletes them to be overwritten.
            if (File.Exists(AppDir + Filename + "L.8xv"))
            {
                Console.WriteLine("Deleting L!");
                File.Delete(AppDir + Filename + "L.8xv");
            }
                
            if (File.Exists(AppDir + Filename + "R.8xv"))
            {
                Console.WriteLine("Deleting R!");
                File.Delete(AppDir + Filename + "R.8xv");
            }

            errorCode = 55;
           
            //both picture's ini file
            string[] iniLines = {"/Leave this alone",
"#GroupPalette      : image_palette.png",
"/put your image names here",
"#PNGImages         :",
 "Left",
 "Right",

"/Leave this alone",
"#GroupICE          : gfx",
"#Palette           : image_palette.png",
"/Put your image names here (same as above)",
"#PNGImages         :",
 "Left",
 "Right",

"/name of your output app var (maximum of 8 characters)",
"#AppvarICE         :" +Filename+"L",
"/This will be at the very beginning of the app var (add underscores to the end to make the whole header 16 chars long)",
"/Never change the FIRST 8 characters. The LAST 8 characters will be used as the image name in the program.",
"#OutputHeader      : HDPICV2L"+FilenameEight,
"#OutputPalettes    : gfx",
"/Image name of LEFT image",
"#PNGImages         :",
 "Left",

"/name of your output app var (maximum of 8 characters) (does not need to be the same as above)",
"#AppvarICE         : "+Filename+"R",
"/This will be at the very beginning of the app var (add underscores to the end to make the whole header 16 chars long)",
"/Never change the FIRST 8 characters. The LAST 8 characters will be used as the image name in the program. (make sure it's the same as above)",
"#OutputHeader      : HDPICV2R"+FilenameEight,
"#OutputPalettes    : gfx",
"/image name of RIGHT image",
"#PNGImages         :",
 "Right",

"#AppvarICE         : "+Filename+"P",
"#OutputHeader      : HDPALV1B"+FilenameEight,
"#OutputPalettes    : gfx",
"#PNGImages         :",
"  image_palette.png"};




            
            //saves the ini text and runs convpng
            try
            {
                errorCode = 56;
                System.IO.File.WriteAllLines(AppDir + @"convpng.ini", iniLines);
                errorCode = 57;
                Process.Start(AppDir + @"windows_convpng.exe");
            }
            catch (Exception e)
            {
                conversionFail = 1;
                MessageBox.Show("Error! code: "+errorCode+ "\nMake sure you have windows_convpng.exe at the following directory: \n" + AppDir);

                return;
            }
            
            /*if(!File.Exists(AppDir+Filename + "L.8xv"))
            {
                if (highQualityCrop == 1)
                {
                    highQualityCrop = 0;
                    MessageBox.Show("Warning: Left Image too big, attempting to reduce quality.");
                    SaveCreate();
                    //return;
                }else
                {
                    conversionFail = 1;
                    Console.WriteLine(errorCode);
                    MessageBox.Show("Error: Could not convert left image! Try reducing image quality and try again.");
                    return;
                }
                
            }*/

            
        }

        private void button1_Click(object sender, EventArgs e)
        {
            Process.Start(AppDomain.CurrentDomain.BaseDirectory);
        }

        private void SettingsButton_Click(object sender, EventArgs e)
        {
            //SettingsForum.Show();
            return;
        }
    }
    
}
